{"version":3,"sources":["../src/adapter/lucid_resource.ts"],"sourcesContent":["import { LucidModel } from '@adonisjs/lucid/types/model'\nimport { SchemaInspector } from 'knex-schema-inspector/dist/types/schema-inspector.js'\n\nimport { LucidColumnMetadata, LucidResourceMetadata } from '../types.js'\n\nexport default class LucidResource {\n  protected metadata: LucidResourceMetadata = {\n    columns: new Map(),\n    relations: new Map(),\n  }\n\n  constructor(\n    public model: LucidModel,\n    public connectionName: string\n  ) {}\n\n  async assignMetadata(inspector: SchemaInspector) {\n    const columns = await inspector.columnInfo(this.model.table)\n\n    const columnsMap = new Map<string, LucidColumnMetadata>()\n    columns.forEach((column) => {\n      const lucidColumnDefinitions = [...this.model.$columnsDefinitions.entries()]\n      const lucidColumn = lucidColumnDefinitions.find(\n        ([_key, info]) => info.columnName === column.name\n      )\n      const lucidRelation = [...this.model.$relationsDefinitions.values()].find(\n        (relation) => (relation as any).options?.foreignKey === column.name\n      )\n\n      if (lucidColumn) {\n        columnsMap.set(lucidColumn[0], {\n          lucidColumn: lucidColumn[1],\n          lucidRelation,\n          databaseColumn: column,\n        })\n      }\n    })\n\n    this.metadata = {\n      columns: columnsMap,\n      relations: this.model.$relationsDefinitions,\n    }\n  }\n\n  getMetadata() {\n    return this.metadata\n  }\n}\n"],"mappings":";;;;;AAKA,IAAqBA,gBAArB,MAAqBA;EAArB,OAAqBA;;;;;EACTC;EAKVC,YACSC,OACAC,gBACP;SAFOD,QAAAA;SACAC,iBAAAA;SAPCH,WAAkC;MAC1CI,SAAS,oBAAIC,IAAAA;MACbC,WAAW,oBAAID,IAAAA;IACjB;EAKG;EAEH,MAAME,eAAeC,WAA4B;AAC/C,UAAMJ,UAAU,MAAMI,UAAUC,WAAW,KAAKP,MAAMQ,KAAK;AAE3D,UAAMC,aAAa,oBAAIN,IAAAA;AACvBD,YAAQQ,QAAQ,CAACC,WAAAA;AACf,YAAMC,yBAAyB;WAAI,KAAKZ,MAAMa,oBAAoBC,QAAO;;AACzE,YAAMC,cAAcH,uBAAuBI,KACzC,CAAC,CAACC,MAAMC,IAAAA,MAAUA,KAAKC,eAAeR,OAAOS,IAAI;AAEnD,YAAMC,gBAAgB;WAAI,KAAKrB,MAAMsB,sBAAsBC,OAAM;QAAIP,KACnE,CAACQ,aAAcA,SAAiBC,SAASC,eAAef,OAAOS,IAAI;AAGrE,UAAIL,aAAa;AACfN,mBAAWkB,IAAIZ,YAAY,CAAA,GAAI;UAC7BA,aAAaA,YAAY,CAAA;UACzBM;UACAO,gBAAgBjB;QAClB,CAAA;MACF;IACF,CAAA;AAEA,SAAKb,WAAW;MACdI,SAASO;MACTL,WAAW,KAAKJ,MAAMsB;IACxB;EACF;EAEAO,cAAc;AACZ,WAAO,KAAK/B;EACd;AACF;","names":["LucidResource","metadata","constructor","model","connectionName","columns","Map","relations","assignMetadata","inspector","columnInfo","table","columnsMap","forEach","column","lucidColumnDefinitions","$columnsDefinitions","entries","lucidColumn","find","_key","info","columnName","name","lucidRelation","$relationsDefinitions","values","relation","options","foreignKey","set","databaseColumn","getMetadata"]}